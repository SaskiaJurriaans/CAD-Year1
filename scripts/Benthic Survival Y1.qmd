---
title: "CAD Benthic Survival Y1"
author: "SJ"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1")
```

Script options:

-   **echo=FALSE**: Prevents the R code from being displayed in the output document.

-   **results='hide'**: Hides the results/output of the R code.

-   **message=FALSE**: Suppresses messages generated by the code.

-   **warning=FALSE**: Suppresses warnings generated by the code.

# Prepare packages

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#install.packages("tidyverse")
library (tidyverse) 
library(ggplot2) 
library(readxl) 
library(dplyr) 
library(readxl) 
library(vegan) 
library(GGally) 
library(corrplot) 
library(car) 
library(mvabund) 
library(scales) 
library(ggrepel) 
library(readxl) 
library(FactoMineR)
library(factoextra)
library(Hmisc) 
library(corrplot)
library(stats)
#install.packages("corrr") 
library(corrr) 
library(ggcorrplot) 
library(dplyr) 
library(tidyr) 
library(RColorBrewer) 
library(readxl)
```

# Load data

```{r, message=FALSE, warning=FALSE}
#| label: import data
survival <- read_excel("data/YEAR1_Survival.xlsx", 
    col_types = c("numeric", "skip", "text", 
        "skip", "skip", "numeric", "skip", 
        "text", "text", "numeric", "skip", 
        "text", "numeric", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"), na = "na")

Y1Benthic <- read_excel("data/YEAR1_Benthic_data.xlsx", na = "na")
```

**Restructure dataframes**

```{r}
#select final census timepoint which is t3 for Heron and t6 for Davies and Moore 
survival_master_H <- survival |> 
  filter(Reef == "Heron", 
         Census == "t3", 
         Tab_ID == 1) 

survival_master_MD <- survival |> 
  filter(Census == "t6", 
         !Reef == "Heron", 
         Tab_ID ==1)

#combine t2 Heron and t6 Moore&Davies 
survival_t6<-rbind(survival_master_MD,survival_master_H) 

#select only columns ReefDev and SurvDev which is renamed Survival 
Y1Survival <- survival_t6 |> 
  select(Reef, Site, ReefDev, SurvDev) |> 
  rename(Survival = SurvDev)

#free up space 
remove(survival, survival_master_H, survival_master_MD, survival_t6)
```

**Check data**

```{r, echo=FALSE, results='hide'}
head (Y1Benthic) 
head (Y1Survival)
str(Y1Benthic) 
str (Y1Survival)
colnames(Y1Benthic) 
colnames(Y1Survival)
```

```{r}
#Mutate data to indicate if factor or numeric 
Y1Survival <- Y1Survival |>
  mutate(ReefDev=factor(ReefDev), 
         Reef=factor(Reef), 
         Site=factor(Site), 
         Survival=as.numeric(Survival))

Y1Benthic <- Y1Benthic |>
  mutate(ReefDev=factor(ReefDev), 
         Reef=factor(Reef), 
         Site=factor(Site),
         CCACyano = CCA + Cyano) |> 
  select(-c(CCA, Cyano))

Y1Benthic_pooled <- Y1Benthic |>
  mutate(Acro = (Acro_br + Acro_dig + Acro_cor + Acro_tab + Acro_bot), 
         HC = (HC_en + HC_fol + HC_mas + HC_sm + HC_free + HC_br)) |> 
  select(-c(Acro_br, Acro_dig, Acro_cor, Acro_tab, Acro_bot, HC_en, HC_fol,HC_mas,HC_sm,HC_free,HC_br))
```

```{r}
#merge datasets 
Y1BenticSurv <- left_join(Y1Benthic, Y1Survival, by = c("Reef", "Site", "ReefDev"))
colnames(Y1BenticSurv)
```

```{r}
#merge datasets with pooled benthic groups
Y1BenticSurv_pooled <- left_join(Y1Benthic_pooled, Y1Survival, by = c("Reef", "Site", "ReefDev")) 
colnames(Y1BenticSurv_pooled)
```

**Filter rows to keep only those present in Y1 Survival**

```{r}
Y1BenticSurv <- Y1BenticSurv |>
  filter(!is.na(Survival)) 

Y1BenticSurv_pooled <- Y1BenticSurv_pooled |>
  filter(!is.na(Survival))

#free up space 
remove(Y1Benthic_pooled)
```

# \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# ALL REEFS

### PCA: Comm Comp by Reef

```{r}
#Remove variables you won't use in PCA 
df_short <- subset(Y1BenticSurv_pooled, select = -c(Site, ReefDev, Survival))

#PCA benthic cover 
short.pca <- PCA(df_short[,-1])

#make reef a factor 
df_short <- df_short |>
  mutate(Reef=factor(Reef))

#make pca by reef 
fviz_pca_biplot(short.pca, label = "var", 
                habillage=df_short$Reef, 
                addEllipses=TRUE, 
                ellipse.level=0.95,
                ggtheme = theme_minimal())
```

```{r}
#Contributions of variables to Dim1
fviz_contrib(short.pca, choice = "var", axes = 1, top = 10) 
```

**OUTPUT**: Top contributions for PC1: **CCA and Cyano** (UPDATE: pooled these two together as these are strong posivte correlated), next **EAM** and then Sand and then all biologic groups

```{r}
#Contributions of variables to Dim2
fviz_contrib(short.pca, choice = "var", axes = 2, top = 10)
```

**OUTPUT**: Top contributions for PC2: **Halimeda**, then **Acro_branching**, **HC massive**, Soft Coral etc. Need to consider if all acro growthforms are pooled together and all other hard corals are pooled together. **UPDATE**: pooled growth forms together, so now Acro is top contributor then halimeda, then soft coral

### **Permanova**

```{r}
#scale data
df_scaled <- scale(df_short[ 2:12])

#create dist-Matrix 
dist_matrix <- vegdist(df_scaled, method = "euclidean")

ResultBenthic <- adonis2(dist_matrix ~ Reef, data = df_short)
ResultBenthic
```

The PERMANOVA analysis results suggest that the factor Reef explains a small but statistically significant portion of the variation in the data (R² = 0.04693, p = 0.001). Despite the small effect size, the results are statistically significant, indicating that the different reefs have distinct community compositions as captured by the distance matrix.

### **Correlation plot**

```{r}
#corr plots to identify relationships 
df_short[,-1] %>%
  cor %>%
  corrplot(type='upper', order='FPC', diag=FALSE) 
```

**OUTPUT**: CyanoCCA and EAM have a negative correlation.

### PCA: Survival by Reef

```{r}
#Make survival a factor
pooled_factor <- Y1BenticSurv_pooled |> 
  mutate(Survival = factor(Survival)) |> 
  select(-c(Reef, Site, ReefDev))
```

```{r}
#PCA with new dataset to show survival vs no survival 
benth.pca_pooled <- PCA(pooled_factor[,-12]) 

fviz_pca_biplot(benth.pca_pooled, label = "var", 
                habillage=pooled_factor$Survival, 
                addEllipses=TRUE, 
                ellipse.level=0.95, 
                ggtheme = theme_minimal())
```

```{r}
fviz_contrib(benth.pca_pooled, choice = "var", axes = 1, top = 10) 
```

**OUTPUT:** Top contributions for PC1: **EAM** and **CCA&Cyano** \> next Sand \> HC \> MA \> rest

```{r}
#Contributions of variables to Dim2
fviz_contrib(benth.pca_pooled, choice = "var", axes = 2, top = 10)
```

**OUTPUT:** Top contributions for PC2: Acro \> HaliMA, SC, RedMA \> Other \> BrownMA etc

### Permanova

```{r}
#scale data
df_scaled <- scale(pooled_factor[ 1:11])

#create dist-Matrix 
dist_matrix <- vegdist(df_scaled, method = "euclidean")

ResultSurvival <- adonis2(dist_matrix ~ Survival, data = pooled_factor)
ResultSurvival
```

**Output:** Significant difference between survival groups (p= 0.015). This means the survival status (0 or 1) has a significant effect on the multivariate distances in the data. However, the R-squared value is quite low (`0.00325`), meaning that while [the difference is statistically significant, the actual variance explained by the survival status is very small]{.underline}. This suggests that other factors may also play a significant role in explaining the variance in the data.

### GLMs

```{r}
#GLMs - start with categories with highest contribution 
logit_modelCCAcyano <- glm(Survival ~ CCACyano , data = Y1BenticSurv_pooled, family = "binomial") 
summary(logit_modelCCAcyano) 
```

**OUTPUT**: CyanoCCA is not significant (p=0.416)

```{r}
logit_modelEAM <- glm(Survival ~ EAM , data = Y1BenticSurv_pooled, family = "binomial") 
summary(logit_modelEAM) 
```

**OUTPUT**: EAM is not significant (p=0.162)

```{r}
logit_modelAcro <- glm(Survival ~ Acro , data = Y1BenticSurv_pooled, family = "binomial") 
summary(logit_modelAcro) 
```

**OUTPUT**: Acro is not significant (p=0.0)

```{r}
logit_modelHali <- glm(Survival ~ HaliMA , data = Y1BenticSurv_pooled, family = "binomial") 
summary(logit_modelHali) 
```

**OUTPUT:** Halimeda is significant (p = 0.0012)

```{r}
#GLMs - start with categories with highest contribution 
logit_modelHC <- glm(Survival ~ HC , data = Y1BenticSurv_pooled, family = "binomial") 
summary(logit_modelHC) 
```

### Figures

**CCA&Cyano**

```{r}
#Plotting significant results 
ggplot(Y1BenticSurv_pooled, aes(x = CCACyano, y = Survival)) + 
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() + 
  ylab("Proportion Survival") + 
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Epilithic algal matrix (EAM)**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = EAM, y = Survival)) + 
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  ylab("Proportion Survival") + 
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Sand**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = Sand_Sed, y = Survival)) + 
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  ylab("Proportion Survival") + 
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Acro**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = Acro, y = Survival)) + 
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() + 
  ylab("Proportion Survival") + 
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Hard coral**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = HC, y = Survival)) + 
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() + 
  ylab("Proportion Survival") +
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Soft Coral**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = SC, y = Survival)) + 
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  ylab("Proportion Survival") +
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

**Halimeda**

```{r}
ggplot(Y1BenticSurv_pooled, aes(x = HaliMA, y = Survival)) +
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() + 
  ylab("Proportion Survival") + 
  theme(axis.text = element_text(angle = 90, vjust = 0.5))
```

# \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# DAVIES

```{r}
Davies <- Y1BenticSurv_pooled |> filter(Reef == "Davies")

#Filter rows to keep only those present in Y1 Survival
Davies <- Davies |>
  filter(!is.na(Survival), 
         !is.na(Sand_Sed))
```

### PCA: Site

```{r}
#Remove variables you won't use in PCA 
Davies_short <- subset(Davies, select = -c(Reef, ReefDev, Survival))

#PCA benthic cover data 
davies.pca <- PCA(Davies_short[,-c(1)])

Davies_factor <- Davies_short|> 
  mutate(Site=factor(Site))
```

### **Figure 1**

```{r}
pca_biplot_Davies<- fviz_pca_biplot(davies.pca,
                                    label = "var", 
                                    habillage=Davies_factor$Site, 
                                    addEllipses=TRUE, 
                                    ellipse.level=0.95, 
                                    ggtheme = theme_minimal())

plot_Davies_ComCompSite <- pca_biplot_Davies + 
  ggtitle("Davies Reef")

plot_Davies_ComCompSite
```

```{r}
#Contributions of variables to Dim1
fviz_contrib(davies.pca, choice = "var", axes = 1, top = 10)
```

**OUTPUT**: EAM 44.1%, CCACyano 24.9%, HC 12.9%, Sand 6.7%, rest \#

```{r}
#Contributions of variables to Dim2 
fviz_contrib(davies.pca, choice = "var", axes = 2, top = 10)
```

**OUTPUT**: BrownMA 31.6%, HaliMA 24.9%, Acro 21.0%, SoftCor 6.6%, rest

```{r}
#Calculate exact values of contributions 
contributions <- davies.pca$var$contrib 
dim1_contributions <- contributions[, 1] 
dim2_contributions <- contributions[, 2]
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC1 
contributions1_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim1)) 

contributions1_df
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC2 
contributions2_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim2)) 

contributions2_df
```

### **Permanova**

```{r}
#scale data 
Scaleddavies <- scale(Davies[ 4:14]) 

#create dist-Matrix 
dist_matrix <- vegdist(Scaleddavies, method = "euclidean")

DaviesPerm <- adonis2(dist_matrix ~ Site, data = Davies_short)
DaviesPerm
```

**OUTPUT**: Site is significant (R2 = 0.12679, p = 0.001)

### Correlation plot

```{r}
#corr plots to identify relationships 
Davies[,-c(1:3)] %>% cor %>%
  corrplot(type='upper', 
           order='FPC', 
           diag=FALSE)
```

### PCA: Survival

```{r}
#new dataset for PCA 
Davies_short2 <- subset(Davies, select = -c(Site, ReefDev, Reef))

#Convert Survival to factor
Davies_short2 <- Davies_short2 |> 
  mutate(Survival=factor(Survival))

#PCA with new dataset to show survival vs no survival 
daviessurv.pca <- PCA(Davies_short2[,-12])
```

### Figure 2

```{r}
#Visualize PCA Biplot - FIGURE 2 
plot_Davies_Survival <- fviz_pca_biplot(daviessurv.pca, 
                                        label = "var", 
                                        habillage=Davies_short2$Survival, 
                                        addEllipses=TRUE, 
                                        ellipse.level=0.95,
                                        ggtheme = theme_minimal()) 
plot_Davies_Survival
```

### Permanova

```{r}
#scale data
df_scaled <- scale(Davies_short2[ 1:11])

#create dist-Matrix 
dist_matrix <- vegdist(df_scaled, method = "euclidean")

ResultSurvival <- adonis2(dist_matrix ~ Survival, data = Davies_short2)
ResultSurvival
```

**Output:** No significant difference between survival groups (p=0.949)

### Extract values and interpretation of values

```{r}
# Extract eigenvalues (variance explained by each principal component) 
eigenvalues <- daviessurv.pca$eig

#Extract variable contributions to the principal components
var_contributions <- daviessurv.pca$var$contrib

#Extract coordinates of the variables
var_coordinates <- daviessurv.pca$var$coord

#Extract the coordinates of the individuals
ind_coordinates <- daviessurv.pca$ind$coord

# Display the results
list( eigenvalues = eigenvalues, 
      var_contributions = var_contributions, 
      var_coordinates = var_coordinates)
```

**Eigenvalues Dataframe -** These represent the amount of variance explained by each principal component.

```{r}
eigenvalues_df <- data.frame(Dimension = 1:nrow(eigenvalues), 
                             Eigenvalue = eigenvalues[, 1], 
                             PercentageOfVariance = eigenvalues[, 2], 
                             CumulativePercentage = eigenvalues[, 3] ) 
print(eigenvalues_df)
```

**Variables contributions dataframe -** These indicate how much each variable contributes to each principal component.

```{r}
var_contributions_df <- as.data.frame(var_contributions) 
print(var_contributions_df)
```

**INTERPRETATION:**

**Eigenvalues**: The first two principal components (PC1 and PC2) together explain approximately 30.91% of the total variance in the dataset. Including up to PC4, the cumulative variance explained is 51.90%, indicating that the first four components capture about half of the total variability.

**Variable Contributions**: PC1 is mainly driven by EAM, CCACyano, and HC, accounting for 18.13% of the variance. PC2 is significantly influenced by BrownMA, HaliMA, Acro, and SC, explaining 12.79% of the variance. PC3 is dominated by Acro and Other_org, accounting for 10.66% of the variance. PC4 sees contributions from RedMA, CCACyano, Other_org, HC, and GreenMA, explaining 10.33% of the variance. PC5 is heavily influenced by RedMA, explaining 9.01% of the variance.

The PCA results suggest that the different types of macroalgae (BrownMA, GreenMA, HaliMA, RedMA), other organisms (Other_org), and other environmental variables (EAM, CCACyano, HC) contribute differently to the variability in the data. The first few components capture a significant portion of this variability, indicating their importance in distinguishing sites.

### GLMs

```{r}
#GLMs - start with categories with highest contribution 
glm_davies_CCACyano <- glm(Survival ~ CCACyano , data = Davies, family = "binomial") 
summary(glm_davies_CCACyano)

glm_davies_EAM <- glm(Survival ~ EAM , data = Davies, family = "binomial")
summary(glm_davies_EAM)

glm_davies_Acro <- glm(Survival ~ Acro , data = Davies, family = "binomial") 
summary(glm_davies_Acro)

glm_davies_BrownMA <- glm(Survival ~ BrownMA , data = Davies, family = "binomial") 
summary(glm_davies_BrownMA)

glm_davies_HaliMA <- glm(Survival ~ HaliMA , data = Davies, family = "binomial")
summary(glm_davies_HaliMA)

glm_davies_Sand <- glm(Survival ~ Sand_Sed , data = Davies, family = "binomial")
summary(glm_davies_Sand)

glm_davies_HC <- glm(Survival ~ HC , data = Davies, family = "binomial") 
summary(glm_davies_HC)

glm_davies_SC <- glm(Survival ~ SC , data = Davies, family = "binomial") 
summary(glm_davies_SC)
```

### SAVE FIGURES

```{r}
#FIGURE 1 
plot_Davies_ComCompSite <- fviz_pca_biplot(davies.pca,
                                           label = "var",
                                           habillage=Davies_factor$Site, 
                                           addEllipses=TRUE, 
                                           ellipse.level=0.95,
                                           ggtheme = theme_minimal()) + 
  ggtitle("Davies Reef") + 
  labs(color = "Sites", shape = "Sites") + 
  guides(color = guide_legend(title = "Sites"), 
         fill = guide_legend(title = "Sites"), 
         shape = guide_legend(title = "Sites"))

#FIGURE 2 
plot_Davies_Survival <- fviz_pca_biplot(daviessurv.pca, 
                                        label = "var", 
                                        habillage=Davies_short2$Survival, 
                                        addEllipses=TRUE,
                                        ellipse.level=0.95, 
                                        ggtheme = theme_minimal()) + 
  ggtitle("Davies Reef") + 
  labs(color = "Survival", shape = "Survival") + 
  guides(color = guide_legend(title = "Survival"), 
         fill = guide_legend(title = "Survival"), 
         shape = guide_legend(title = "Survival"))

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Davies_Sites.jpeg", plot = plot_Davies_ComCompSite, width = 6, height = 4, dpi = 600)

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Davies_Survival.jpeg", plot = plot_Davies_Survival, width = 6, height = 4, dpi = 600)
```

# \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# HERON

```{r}
Heron <- Y1BenticSurv_pooled |> filter(Reef == "Heron")

#Filter rows to keep only those present in Y1 Survival
Heron <- Heron |>
  filter(!is.na(Survival), 
         !is.na(Sand_Sed))
```

### PCA: Site

```{r}
#Remove variables you won't use in PCA 
Heron_short <- subset(Heron, select = -c(Reef, ReefDev, Survival))

#PCA benthic cover data 
heron.pca <- PCA(Heron_short[,-c(1:3)])

Heron_factor <- Heron_short|> 
  mutate(Site=factor(Site))
```

### **Figure 1**

```{r}
pca_biplot_Heron<- fviz_pca_biplot(heron.pca,
                                    label = "var", 
                                    habillage=Heron_factor$Site, 
                                    addEllipses=TRUE, 
                                    ellipse.level=0.95, 
                                    ggtheme = theme_minimal())

plot_Heron_ComCompSite <- pca_biplot_Heron + 
  ggtitle("Heron Reef")

plot_Heron_ComCompSite
```

```{r}
#Contributions of variables to Dim1
fviz_contrib(heron.pca, choice = "var", axes = 1, top = 10)
```

**OUTPUT**: EAM 44.1%, CCACyano 24.9%, HC 12.9%, Sand 6.7%, rest \#

```{r}
#Contributions of variables to Dim2 
fviz_contrib(heron.pca, choice = "var", axes = 2, top = 10)
```

**OUTPUT**: BrownMA 31.6%, HaliMA 24.9%, Acro 21.0%, SoftCor 6.6%, rest

```{r}
#Calculate exact values of contributions 
contributions <- heron.pca$var$contrib 
dim1_contributions <- contributions[, 1] 
dim2_contributions <- contributions[, 2]
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC1 
contributions1_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim1)) 

contributions1_df
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC2 
contributions2_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim2)) 

contributions2_df
```

### **Permanova**

```{r}
#scale data 
Scaledheron <- scale(Heron[ 4:14]) 

#create dist-Matrix 
dist_matrix <- vegdist(Scaledheron, method = "euclidean")

HeronPerm <- adonis2(dist_matrix ~ Site, data = Heron_short)
HeronPerm
```

**Output:** Site is significant P=0.001)

### Correlation plot

```{r}
#corr plots to identify relationships 
Heron[,-c(1:3)] %>%
  cor %>%
  corrplot(type='upper', 
           order='FPC', 
           diag=FALSE)
```

### PCA: Survival

```{r}
#new dataset for PCA 
Heron_short2 <- subset(Heron, select = -c(Site, ReefDev, Reef))

#Convert Survival to factor
Heron_short2 <- Heron_short2 |> 
  mutate(Survival=factor(Survival))

#PCA with new dataset to show survival vs no survival 
heronsurv.pca <- PCA(Heron_short2[,-12])
```

### Figure 2

```{r}
#Visualize PCA Biplot â FIGURE 2 
plot_Heron_Survival <- fviz_pca_biplot(heronsurv.pca, 
                                        label = "var", 
                                        habillage=Heron_short2$Survival, 
                                        addEllipses=TRUE, 
                                        ellipse.level=0.95,
                                        ggtheme = theme_minimal()) 
plot_Heron_Survival
```

### Permanova

```{r}
#scale data
df_scaled <- scale(Heron_short2[ 1:11])

#create dist-Matrix 
dist_matrix <- vegdist(df_scaled, method = "euclidean")

ResultSurvival <- adonis2(dist_matrix ~ Survival, data = Heron_short2)
ResultSurvival
```

**Output:** Significant variation between survival groups (p=0.026), but low R2 value.

### Extract values and interpretation of values

```{r}
# Extract eigenvalues (variance explained by each principal component) 
eigenvalues <- heronsurv.pca$eig

#Extract variable contributions to the principal components
var_contributions <- heronsurv.pca$var$contrib

#Extract coordinates of the variables
var_coordinates <- heronsurv.pca$var$coord

#Extract the coordinates of the individuals
ind_coordinates <- heronsurv.pca$ind$coord

# Display the results
list( eigenvalues = eigenvalues, 
      var_contributions = var_contributions, 
      var_coordinates = var_coordinates)
```

**Eigenvalues Dataframe -** These represent the amount of variance explained by each principal component.

```{r}
eigenvalues_df <- data.frame(Dimension = 1:nrow(eigenvalues), 
                             Eigenvalue = eigenvalues[, 1], 
                             PercentageOfVariance = eigenvalues[, 2], 
                             CumulativePercentage = eigenvalues[, 3] ) 
print(eigenvalues_df)
```

**Variables contributions dataframe -** These indicate how much each variable contributes to each principal component.

```{r}
var_contributions_df <- as.data.frame(var_contributions) 
print(var_contributions_df)
```

**INTERPRETATION:**

**Eigenvalues**: The first two principal components (PC1 and PC2) together explain approximately 30.91% of the total variance in the dataset. Including up to PC4, the cumulative variance explained is 51.90%, indicating that the first four components capture about half of the total variability.

**Variable** **Contributions**: PC1 is mainly driven by EAM, CCACyano, and HC, accounting for 18.13% of the variance. PC2 is significantly influenced by BrownMA, HaliMA, Acro, and SC, explaining 12.79% of the variance. PC3 is dominated by Acro and Other_org, accounting for 10.66% of the variance. PC4 sees contributions from RedMA, CCACyano, Other_org, HC, and GreenMA, explaining 10.33% of the variance. PC5 is heavily influenced by RedMA, explaining 9.01% of the variance.

The PCA results suggest that the different types of macroalgae (BrownMA, GreenMA, HaliMA, RedMA), other organisms (Other_org), and other environmental variables (EAM, CCACyano, HC) contribute differently to the variability in the data. The first few components capture a significant portion of this variability, indicating their importance in distinguishing sites.

### GLMs

```{r}
#GLMs - start with categories with highest contribution 
glm_heron_CCACyano <- glm(Survival ~ CCACyano , data = Heron, family = "binomial") 
summary(glm_heron_CCACyano)
# CCACyano: Not significant (p-value = 0.286637)

glm_heron_EAM <- glm(Survival ~ EAM , data = Heron, family = "binomial")
summary(glm_heron_EAM)
# EAM: Not significant (p-value = 0.366)

glm_heron_Acro <- glm(Survival ~ Acro , data = Heron, family = "binomial") 
summary(glm_heron_Acro)
# Acro: Not significant (p-value = 0.41595)

glm_heron_BrownMA <- glm(Survival ~ BrownMA , data = Heron, family = "binomial") 
summary(glm_heron_BrownMA)
# BrownMA: Not significant (p-value = 0.424014)

glm_heron_HaliMA <- glm(Survival ~ HaliMA , data = Heron, family = "binomial")
summary(glm_heron_HaliMA)
#HaliMA: Significant (p-value = 0.0106, *) - Higher values of HaliMA increase the odds of survival.

glm_Heron_Sand <- glm(Survival ~ Sand_Sed , data = Heron, family = "binomial") 
summary(glm_Heron_Sand)
# Sand_Sed: Marginally significant (p-value = 0.05111, .) - Higher values of Sand_Sed decrease the odds of survival.

glm_Heron_HC <- glm(Survival ~ HC , data = Heron, family = "binomial") 
summary(glm_Heron_HC)
# HC: Significant (p-value = 0.0188) - Higher values of HC increase the odds of survival.

glm_Heron_SC <- glm(Survival ~ SC , data = Heron, family = "binomial") 
summary(glm_Heron_SC)
# SC: Not significant (p-value = 0.802508) 
```

### SAVE FIGURES

```{r}
#FIGURE 1 
plot_heron_ComCompSite <- fviz_pca_biplot(heron.pca,
                                           label = "var",
                                           habillage=Heron_factor$Site, 
                                           addEllipses=TRUE, 
                                           ellipse.level=0.95,
                                           ggtheme = theme_minimal()) + 
  ggtitle("Heron Reef") + 
  labs(color = "Sites", shape = "Sites") + 
  guides(color = guide_legend(title = "Sites"), 
         fill = guide_legend(title = "Sites"), 
         shape = guide_legend(title = "Sites"))

#FIGURE 2 
plot_heron_Survival <- fviz_pca_biplot(heronsurv.pca, 
                                        label = "var", 
                                        habillage=Heron_short2$Survival, 
                                        addEllipses=TRUE,
                                        ellipse.level=0.95, 
                                        ggtheme = theme_minimal()) + 
  ggtitle("Heron Reef") + 
  labs(color = "Survival", shape = "Survival") + 
  guides(color = guide_legend(title = "Survival"), 
         fill = guide_legend(title = "Survival"), 
         shape = guide_legend(title = "Survival"))

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Heron_Sites.jpeg", plot = plot_heron_ComCompSite, width = 6, height = 4, dpi = 600)

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Heron_Survival.jpeg", plot = plot_heron_Survival, width = 6, height = 4, dpi = 600)
```

```{r}
#Plotting significant results
plot_Heron_HaliMA <- ggplot(Heron, aes(x = HaliMA, y = Survival)) +
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  theme_bw() +
  labs(title = "Effect of halimeda on Survival", x = "Halimeda abundance", y = "Survival (%)") 

plot_Heron_HC <- ggplot(Heron, aes(x = HC, y = Survival)) +
  geom_point() + geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  labs(title = "Effect of non-acroporid hard coral on Survival", x = "non-Acroporid hard coral abundance", y = "Survival (%)") 
```

# \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# MOORE

```{r}
Moore <- Y1BenticSurv_pooled |> filter(Reef == "Moore")

#Filter rows to keep only those present in Y1 Survival
Moore <- Moore |>
  filter(!is.na(Survival), 
         !is.na(Sand_Sed))
```

### PCA: Site

```{r}
#Remove variables you won't use in PCA 
Moore_short <- subset(Moore, select = -c(Reef, ReefDev, Survival))

#PCA benthic cover data 
Moore.pca <- PCA(Moore_short[,-c(1:3)])

Moore_factor <- Moore_short|> 
  mutate(Site=factor(Site))
```

### **Figure 1**

```{r}
pca_biplot_Moore<- fviz_pca_biplot(Moore.pca,
                                    label = "var", 
                                    habillage=Moore_factor$Site, 
                                    addEllipses=TRUE, 
                                    ellipse.level=0.95, 
                                    ggtheme = theme_minimal())

plot_Moore_ComCompSite <- pca_biplot_Moore + 
  ggtitle("Moore Reef")

plot_Moore_ComCompSite
```

```{r}
#Contributions of variables to Dim1
fviz_contrib(Moore.pca, choice = "var", axes = 1, top = 10)
```

**OUTPUT**: EAM 31.1%, CCACyano 23.0%, RedMA 11.6%, Sand 10.23%, rest

```{r}
#Contributions of variables to Dim2 
fviz_contrib(Moore.pca, choice = "var", axes = 2, top = 10)
```

**OUTPUT**: Acro 30.9%, HaliMA 27.2%, GreenMA 16.3%, HC 8.9%, rest

```{r}
#Calculate exact values of contributions 
contributions <- Moore.pca$var$contrib 
dim1_contributions <- contributions[, 1] 
dim2_contributions <- contributions[, 2]
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC1 
contributions1_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim1)) 

contributions1_df
```

```{r}
#Create a data frame with the contributions and sort by strongest contributing variables for PC2 
contributions2_df <- data.frame( Variable = rownames(contributions), 
                                 Contribution_Dim1 = dim1_contributions, 
                                 Contribution_Dim2 = dim2_contributions) |> 
  arrange(desc(Contribution_Dim2)) 

contributions2_df
```

### **Permanova**

```{r}
#scale data 
ScaledMoore <- scale(Moore[ 4:14]) 

#create dist-Matrix 
dist_matrix <- vegdist(ScaledMoore, method = "euclidean")

MoorePerm <- adonis2(dist_matrix ~ Site, data = Moore_short)
MoorePerm
```

**OUTPUT**: Site: p=0.001, meaning that differences in the data can be attributed to differences between the sites. Also, the R2 value is 0.28785, meaning that 28.78% of the variance in the data is explained by the differences between sites, which is substantial. This indicates that Site is an important factor in explaining variability in the data.

### Correlation plot

```{r}
#corr plots to identify relationships 
Moore[,-c(1:3)] %>%
  cor %>%
  corrplot(type='upper', 
           order='FPC', 
           diag=FALSE)
```

### PCA: Survival

```{r}
#new dataset for PCA 
Moore_short2 <- subset(Moore, select = -c(Site, ReefDev, Reef))

#PCA with new dataset to show survival vs no survival 
Mooresurv.pca <- PCA(Moore_short2[,-12])
```

```{r}
#Convert Survival to factor
Moore_short2_factor <- Moore_short2 |> 
  mutate(Survival=factor(Survival))
```

### Figure 2

```{r}
#Visualize PCA Biplot â FIGURE 2 
plot_Moore_Survival <- fviz_pca_biplot(Mooresurv.pca, 
                                        label = "var", 
                                        habillage=Moore_short2_factor$Survival, 
                                        addEllipses=TRUE, 
                                        ellipse.level=0.95,
                                        ggtheme = theme_minimal()) 
plot_Moore_Survival
```

### Permanova

```{r}
#scale data
df_scaled <- scale(Moore_short2[ 1:11])

#create dist-Matrix 
dist_matrix <- vegdist(df_scaled, method = "euclidean")

ResultSurvival <- adonis2(dist_matrix ~ Survival, data = Moore_short2)
ResultSurvival
```

**Output:** strong significant difference between survival groups (p=0.008). But low effect size (R2 = 0.01065), which means only 1.065% of variance is explained by survival. This suggests that other variables contribute much more to the overall variation in the dataset.

### Extract values and interpretation of values

```{r}
# Extract eigenvalues (variance explained by each principal component) 
eigenvalues <- Mooresurv.pca$eig

#Extract variable contributions to the principal components
var_contributions <- Mooresurv.pca$var$contrib

#Extract coordinates of the variables
var_coordinates <- Mooresurv.pca$var$coord

#Extract the coordinates of the individuals
ind_coordinates <- Mooresurv.pca$ind$coord

# Display the results
list( eigenvalues = eigenvalues, 
      var_contributions = var_contributions, 
      var_coordinates = var_coordinates )
```

**Eigenvalues Dataframe -** These represent the amount of variance explained by each principal component.

```{r}
eigenvalues_df <- data.frame(Dimension = 1:nrow(eigenvalues), 
                             Eigenvalue = eigenvalues[, 1], 
                             PercentageOfVariance = eigenvalues[, 2], 
                             CumulativePercentage = eigenvalues[, 3] ) 
print(eigenvalues_df)
```

**Variables contributions dataframe -** These indicate how much each variable contributes to each principal component.

```{r}
var_contributions_df <- as.data.frame(var_contributions) 
print(var_contributions_df)
```

INTERPRETATION:

**Eigenvalues**: The cumulative variance explained by the first two principal components (PC1 and PC2) is 35.60%. Including up to PC4, the cumulative variance explained reaches 56.60%, indicating that these four components capture over half of the total variability in the benthic community composition.

**Variable Contributions:** PC1 is mainly driven by EAM, CCACyano, Sand and RedMA, accounting for 23.46% of the variance. PC2 is significantly influenced by Acro, HaliMA, GreenMA, and HC, explaining 12.14% of the variance. PC3 is dominated by SC, BrownMA and ACro, accounting for 10.94% of the variance. PC4 sees contributions from GreenMA, Other_org, and Acro, explaining 10.06% of the variance.

#The analysis identifies EAM, CCACyano, and Sand_Sed as primary drivers of community composition along the first principal component.The high proportion of variance explained by the first four principal components indicates substantial environmental heterogeneity within Moore Reef.

### GLMs

```{r}
#GLMs - start with categories with highest contribution 
glm_Moore_CCACyano <- glm(Survival ~ CCACyano , data = Moore, family = "binomial") 
summary(glm_Moore_CCACyano)
# p-value: 0.2626 (Not significant)

glm_Moore_EAM <- glm(Survival ~ EAM , data = Moore, family = "binomial")
summary(glm_Moore_EAM)
#p-value: 0.00906 (Significant) - As EAM increases, the odds of survival increase.

glm_Moore_Acro <- glm(Survival ~ Acro , data = Moore, family = "binomial") 
summary(glm_Moore_Acro)
#p-value: 0.00892 (Significant) - As Acro increases, the odds of survival decrease.

glm_Moore_BrownMA <- glm(Survival ~ BrownMA , data = Moore, family = "binomial") 
summary(glm_Moore_BrownMA)
#p-value: 0.40595 (Not significant) 

glm_Moore_HaliMA <- glm(Survival ~ HaliMA , data = Moore, family = "binomial")
summary(glm_Moore_HaliMA)
#p-value: 0.281 (Not significant)

glm_Moore_Sand <- glm(Survival ~ Sand_Sed , data = Moore, family = "binomial") 
summary(glm_Moore_Sand)
#p-value: 0.955343 (Not significant)

glm_Moore_HC <- glm(Survival ~ HC , data = Moore, family = "binomial") 
summary(glm_Moore_HC)
#p-value: 0.83030  (Not significant)

glm_Moore_SC <- glm(Survival ~ SC , data = Moore, family = "binomial") 
summary(glm_Moore_SC)
#p-value: 0.00883 ** (significant)
```

### SAVE FIGURES

```{r}
#FIGURE 1 
plot_Moore_ComCompSite <- fviz_pca_biplot(Moore.pca,
                                           label = "var",
                                           habillage=Moore_factor$Site, 
                                           addEllipses=TRUE, 
                                           ellipse.level=0.95,
                                           ggtheme = theme_minimal()) + 
  ggtitle("Moore Reef") + 
  labs(color = "Sites", shape = "Sites") + 
  guides(color = guide_legend(title = "Sites"), 
         fill = guide_legend(title = "Sites"), 
         shape = guide_legend(title = "Sites"))

#FIGURE 2 
plot_Moore_Survival <- fviz_pca_biplot(Mooresurv.pca, 
                                        label = "var", 
                                        habillage=Moore_short2_factor$Survival, 
                                        addEllipses=TRUE,
                                        ellipse.level=0.95, 
                                        ggtheme = theme_minimal()) + 
  ggtitle("Moore Reef") + 
  labs(color = "Survival", shape = "Survival") + 
  guides(color = guide_legend(title = "Survival"), 
         fill = guide_legend(title = "Survival"), 
         shape = guide_legend(title = "Survival"))
##OUTPUT on this plot:  Permutation test using the adonis2 function
# To evaluate the influence of the benthic community composition  on survival. 
# Survival accounted for a small but statistically significant portion of the variance (RÂ² = 0.01065, F(1, 236) = 2.5394, p = 0.014). This indicates that although the effect size is modest, survival still has a detectable impact on the community composition within the studied sites.

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Moore_Sites.jpeg", plot = plot_Moore_ComCompSite, width = 6, height = 4, dpi = 600)

ggsave("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Year1/output/Community Composition/PCA_Moore_Survival.jpeg", plot = plot_Moore_Survival, width = 6, height = 4, dpi = 600)
```

```{r}
#Plotting significant results
plot_Moore_EAM <- ggplot(Moore, aes(x = EAM, y = Survival)) +
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  theme_bw() +
  labs(title = "Effect of EAM on Survival", x = "Epilithic Algal Matrix", y = "Survival (%)") 

plot_Moore_Acro <- ggplot(Moore, aes(x = Acro, y = Survival)) +
  geom_point() + geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  labs(title = "Effect of Acropora on Survival", x = "Acropora abundance", y = "Survival (%)") 

plot_Moore_SC <- ggplot(Moore, aes(x = SC, y = Survival)) +
  geom_point() + geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) + 
  theme_bw() +
  labs(title = "Effect of soft coral on Survival", x = "Soft coral abundance", y = "Survival (%)") 
```

# \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# Multiplot significant key contributors

```{r}
#| echo: false
#| warning: false
library(gridExtra)
library(gtable)
library(grid)
library(egg)
```

```{r}
# Arrange all labeled plots in a grid
capture_plot_Moore <- grid.arrange(plot_Moore_EAM, plot_Moore_Acro, plot_Moore_SC, 
                                   nrow = 3)

# Display the arranged plots
capture_plot_Moore

```

```{r}
# Arrange all labeled plots in a grid
capture_plot_Heron <- grid.arrange(plot_Heron_HaliMA, plot_Heron_HC, 
                                   nrow = 2)

# Display the arranged plots
capture_plot_Heron
```

```{r}
# Save the plot using ggsave
ggsave("Figure Multiplot GLM Moore.jpeg", plot = capture_plot_Moore, width = 6, height = 10)
ggsave("Figure Multiplot GLM Heron.jpeg", plot = capture_plot_Heron, width = 6, height = 8)

```
