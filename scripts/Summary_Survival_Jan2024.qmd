---
title: "Survival_summary"
author: "Saskia"
format: html
editor: visual
---

# Data preparation

### Load the required packages

```{r}
library(readxl) 
library(writexl) 
library(dplyr) 
library(openxlsx) 
library(readr) 
library(ggplot2) 
library(patchwork) 
library(cowplot) 
library(lubridate) 
library(tidyr)
library(stringr)
```

### Set the workdrive and load data

```{r}
# Set working directory 
setwd("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Field Data/2022_Deployment_Saskia_YEAR1/Survival data")  


# Import data file 
data_survival <- read_excel("2022_Deployment_Saskia_MasterData.xlsx",
    sheet = "Survival", col_types = c("skip", 
        "skip", "text", "skip", "skip", "numeric", 
        "skip", "text", "text", "text", "skip", 
        "text", "text", "text", "numeric", 
        "skip", "numeric"),
    na = "NA")

data_tab <- read_excel("Dataframes/survival_wide_tab.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"), na = "TRUE")

data_device <- read_excel("Dataframes/survival_wide_device.xlsx", col_types = c("text", "text", "text", 
        "skip", "text", "skip", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"), na = "TRUE")
```

### \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# Data summary

### % survival - dataframes WIDE

Create dataframes that summarises the percentage survival at each site per timepoint for tabs and devices

```{r}
survival_perc_Tab <- data_tab |>
  group_by(Reef, Site, WaveEnergyLevel,Spp) |>
  summarise(NTabs = sum(t0, na.rm=TRUE),
            Perc_t0 = sum(t0, na.rm = TRUE)/NTabs,
            Perc_t1 = sum(t1, na.rm = TRUE)/NTabs,
            Perc_t2 = sum(t2, na.rm = TRUE)/NTabs,
            Perc_t3 = sum(t3, na.rm = TRUE)/NTabs,
            Perc_t4 = sum(t4, na.rm = TRUE)/NTabs,
            Perc_t6 = sum(t6, na.rm = TRUE)/NTabs)

survival_perc_dev <- data_device |>
  group_by(Reef, Site, WaveEnergyLevel) |>
  summarise(NDev = sum(t0, na.rm=TRUE),
            Perc_t0 = sum(t0, na.rm = TRUE)/NDev,
            Perc_t1 = sum(t1, na.rm = TRUE)/NDev,
            Perc_t2 = sum(t2, na.rm = TRUE)/NDev,
            Perc_t3 = sum(t3, na.rm = TRUE)/NDev,
            Perc_t4 = sum(t4, na.rm = TRUE)/NDev,
            Perc_t6 = sum(t6, na.rm = TRUE)/NDev)
```

### Summary % survival - dataframes LONG

Create a summary survival dataframe with a new column that sums up the survival score of all the tabs for each site for each census. Then create an additional dataframe with a new column that sums up the survival score of the devices for each site for each census. Last, combine both dataframes so that there it shows for each site and per census a column with the total number of tabs with survivorship, and the total number of devices with at least one survivor.

```{r}
summary_survival_Dev <- data_survival |>
  filter(!is.na(SurvDev)) |>
  group_by(Reef, Site, WaveEnergyLevel, Census, ExpDay) |>
  summarise(SurvivalNDevices = sum(SurvDev, na.rm=T),
            DevTot =25,
            Perc_SurvDev = sum(SurvDev, na.rm =T)/25)
```

Create summary dataframe that includes species.

```{r}
summary_survival_Spp <- data_survival |>
  group_by(Reef, Site, WaveEnergyLevel, Census, ExpDay, Spp) |>
  summarize(SurvivalNTabs = (sum(SurvTab, na.rm = TRUE))) 

summary_survival_Spp_DavMoore <- summary_survival_Spp |>
  filter(!Reef == "Heron") |>
  mutate(TabTot = 75,
         Perc_SurvTab = SurvivalNTabs/TabTot)


summary_survival_Spp_Heron37 <- summary_survival_Spp |>
  filter(Reef == "Heron") |>
  filter(Site %in% c("H1A", "H2B", "H3A", "H4B", "H5A"))|>
    mutate(TabTot = rep(c(37,38)),
         Perc_SurvTab = SurvivalNTabs/TabTot)

summary_survival_Spp_Heron38 <- summary_survival_Spp |>
  filter(Reef == "Heron") |>
  filter(Site %in% c("H1B", "H2A", "H3B", "H4A", "H5B")) |>
    mutate(TabTot = rep(c(38, 37)),
         Perc_SurvTab = SurvivalNTabs/TabTot)

summary_survival_Spp_Heron <- rbind(summary_survival_Spp_Heron37,summary_survival_Spp_Heron38)

summary_survival_Spp <- rbind(summary_survival_Spp_DavMoore, summary_survival_Spp_Heron)

remove(summary_survival_Spp_Heron, summary_survival_Spp_DavMoore, summary_survival_Spp_Heron37, summary_survival_Spp_Heron38)
```

```{r}
summary_survival <- summary_survival_Dev |>
  left_join(
    summary_survival_Spp)

remove(summary_survival_Dev, summary_survival_Spp)
```

[**Filter to last census (t2 for Heron, t6 for Davies and Moore)**]{.underline}

```{r}
summary_survival_t6 <- summary_survival |>   
  filter(Census == "t6")           #Only show survival at the last timepoint

summary_survival_t2 <- summary_survival |>   
  filter(Census == "t2") |>
  filter(Reef == "Heron")         #only show survival for Heron at t2

summary_survival_finalcensus <- rbind(summary_survival_t6, summary_survival_t2)

remove(summary_survival_t2, summary_survival_t6)
```

[**Overall mean % survival by site**]{.underline}

#NOT RELEVANT, only % at t6 is relevant!! - Get the overall mean percentage survival per site across timepoints.

```{r}
survival_mean_Tab <- survival_perc_Tab |>
  rowwise() |>
  mutate(MeanPerc = mean(c_across(starts_with("Perc")), na.rm = TRUE),
         SDPerc = sd(c_across(starts_with("Perc")), na.rm = TRUE),
         SEPerc = SDPerc/sqrt((NTabs)))
```

```{r}
survival_mean_dev <- survival_perc_dev |>
  rowwise() |>
  mutate(MeanPerc = mean(c_across(starts_with("Perc")), na.rm = TRUE),
         SDPerc = sd(c_across(starts_with("Perc")), na.rm = TRUE),
         SEPerc = SDPerc/sqrt((NDev)))
```

### Fig1a - Boxplot - Mean survival Reef-tabs

```{r, fig.show='all', echo=FALSE}
# Plot 1a - Reef (tab)
plot1a <- ggplot(summary_survival, aes(x = Reef, y = Perc_SurvTab, color = Reef)) +
  geom_boxplot() +
  labs(title = "Mean Survival (tabs)",
       x = "Reef",
       y = "% Survival") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 12),  # Adjust font size of axis text
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12))  # Adjust font size of axis titles)

plot1a

ggsave("Fig1a - Mean survival Reef-tabs.png", plot=plot1a, width = 8, height = 6, dpi = 300)
```

### Fig1b - Boxplot - Mean survival Reef-yield

```{r}
plot1b <- ggplot(summary_survival, aes(x = Reef, y = Perc_SurvDev, color = Reef)) +   
  geom_boxplot() +   
  labs(title = "Mean Survival (yield)", x = "Reef", y = "% Survival") +   
  theme_minimal() +   
  theme(panel.border = element_rect(color = "black", fill = NA),         
        axis.line = element_line(color = "black"),         
        panel.grid.major = element_line(color = "gray",linetype="dashed"),
        panel.grid.minor = element_blank(),         
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),         
        legend.text = element_text(size = 12))  
plot1b 

ggsave("Fig1b - Mean survival Reef-yield.png", plot=plot1b, width = 8, height = 6, dpi = 300) 
```

### 

### Fig2a - Boxplot - Mean survival final census Reef-tabs

```{r}
# Plot 2a - Reef (tab)
plot2a <- ggplot(summary_survival_finalcensus, aes(x = Reef, y = Perc_SurvTab, color = Reef)) +
  geom_boxplot() +
  labs(title = "Mean survival final census (tabs)",
       x = "Reef",
       y = "% Survival") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 12),  # Adjust font size of axis text
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12))  # Adjust font size of axis titles)

plot2a

ggsave("Fig2a - Mean survival final census Reef-tabs.png", plot=plot2a, width = 8, height = 6, dpi = 300)
```

### Fig2b - Boxplot - Mean survival final census Reef-yield

```{r}
plot2b <- ggplot(summary_survival_finalcensus, aes(x = Reef, y = Perc_SurvDev, color = Reef)) +
  geom_boxplot() +
  labs(title = "Mean Survival final census (yield)",
       x = "Reef",
       y = "% Survival") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 12),  # Adjust font size of axis text
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12))  # Adjust font size of axis titles)

plot2b
ggsave("Fig2b - Mean survival final census Reef-yield.png", plot=plot2b, width = 8, height = 6, dpi = 300)

```

### Fig3 - Point - % survival final census yield over sites

```{r}
# Create the plot
plot3 <- ggplot(summary_survival_finalcensus, aes(x = Site, y = Perc_SurvDev, color = Reef)) +
  geom_point(size=3) +
  labs(title = "Survival by sites (final census)",
       x = "Sites",
       y = "% Survival (device yield)") +
  theme_bw() +
  ylim(0,1) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Reef, scales = "free")

plot3
ggsave("Fig3 - Survival final census - yield.png", plot=plot3, width = 14, height = 6, dpi = 300)

```

### Fig4 - Point - % survival Species

```{r}

plot4<- ggplot(summary_survival_finalcensus, aes(x = Site, y = Perc_SurvTab, color = Reef)) +
  geom_point(size=3) +  
  labs(title = "Survival final census",
       x = "Sites",
       y = "% Survival (tabs)") +
  theme_bw() +
  ylim(-0.01,1) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Spp, scales = "free")
plot4

ggsave("Fig4 - Survival by species - tabs.png", plot=plot4, width = 14, height = 6, dpi = 300)

```

### Fig5 - Point - % survival final census yield over ExpDay

```{r}
# Plot with specific days on the x-axis for each reef
plot5 <- ggplot(summary_survival, aes(x = ExpDay, y = Perc_SurvDev, color = Reef)) +
  geom_point(size=3) +
  labs(title = "Survival by time",
       x = "Experiment days",
       y = "% Survival (device yield)") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,500) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Reef, scales = "free")

plot5
ggsave("Fig5 - Survival over time - yield.png", plot=plot5, width = 14, height = 6, dpi = 300)

```

### Fig6- Point - % survival Species over ExpDay

```{r}
plot6 <- ggplot(summary_survival, aes(x = ExpDay, y = Perc_SurvTab, color = Reef)) +
  geom_point(size=3) +
  labs(title = "Survival by species",
       x = "Experiment days",
       y = "% Survival (tabs)") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,500) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Spp, scales = "free")

plot6
ggsave("Fig6 - Survival Spp over time - tab.png", plot=plot6, width = 14, height = 6, dpi = 300)

```

### Fig7- Point - Mean % survival Species (average sites) over ExpDay

```{r}
# Calculate average survival and standard error for each species within each reef at each time point
summary_survival_stats <- summary_survival |>
  group_by(Reef, Census, Spp) |>
  summarise(Avg_Survival = mean(Perc_SurvTab, na.rm = TRUE),
            SE = sd(Perc_SurvTab, na.rm = TRUE) / sqrt(n())) |>
    ungroup() |>
  mutate(ExpDay = c(0, 103, 163, 255, 326, 527, 0, 0, 71, 71, 415, 415, 0, 92,151,247, 337, 525))

# Plot the average survival over time for each species with standard error bars
plot7 <- ggplot(summary_survival_stats, aes(x = ExpDay, y = Avg_Survival, color = Reef)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = Avg_Survival - SE, ymax = Avg_Survival + SE), width = 0.2) +
  facet_wrap(~Spp, scales = "free") +
  labs(title = "Mean Survival Over Time by Species and Reef",
       x = "Experiment Day",
       y = "Average % Survival (tabs)",
       color = "Reef") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,500) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12))

plot7
ggsave("Fig7 - Mean survival Spp over time - tab.png", plot=plot7, width = 14, height = 6, dpi = 300)

```

### Fig8- Point - Mean % survival Species grouped by Reef (average sites) over ExpDay

```{r}
# Plot the average survival over time for each species with standard error bars
plot8 <- ggplot(summary_survival_stats, aes(x = ExpDay, y = Avg_Survival, color = Spp)) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = Avg_Survival - SE, ymax = Avg_Survival + SE), width = 0.2) +
  facet_wrap(~Reef, scales = "free") +
  labs(title = "Mean Survival Over Time by Species and Reef",
       x = "Experiment Day",
       y = "Average % Survival (tabs)",
       color = "Species") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,500) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12))

plot8
ggsave("Fig8 - Mean survival Spp by Reef over time - tab.png", plot=plot8, width = 14, height = 6, dpi = 300)
```

### Save datasets

```{r}
# Specify the desired file name and path
file_name <- "Summary Survival YEAR1.xlsx"
file_path <- paste0("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Field Data/2022_Deployment_Saskia_YEAR1/Survival data/Dataframes/", file_name)

# Write the dataset to an Excel file
write.xlsx(summary_survival, file_path)


# Specify the desired file name and path
file_name <- "Summary Survival YEAR1 FinalCensus.xlsx"
file_path <- paste0("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Field Data/2022_Deployment_Saskia_YEAR1/Survival data/Dataframes/", file_name)

# Write the dataset to an Excel file
write.xlsx(summary_survival_finalcensus, file_path)
```

### \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

# Plot data against current meters

### Load the data

```{r}
data_env <- read_excel("C:/Users/sjurriaa/Australian Institute of Marine Science/Carly Randall - Randall Lab/CAD/CAD Field Data/2022_Deployment_Saskia_YEAR1/Instruments data/Marotte_HS_all_reefs/Metrics selection/FinalMetrics_Summary.xlsx", 
    col_types = c("text", "text",  
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "text", "text"), 
    na = "na")

# free up space
remove(plot1a, plot1b, plot2a,plot2b, plot3, plot4, plot5, plot6, plot7, plot8)
```

### Merge dataframes

Merge summary data with environmental data

```{r}
merged_data <- merge(summary_survival, data_env, by = c("Reef", "Site"), all.x = TRUE)
```

Make selection for final census

```{r}
merged_data_t6 <- merged_data |>   
  filter(Census == "t6")           #Only show survival at the last timepoint

merged_data_t2 <- merged_data |>   
  filter(Census == "t2") |>
  filter(Reef == "Heron")         #only show survival for Heron at t2

merged_data_finalcensus <- rbind(merged_data_t6, merged_data_t2)

remove(merged_data_t2, merged_data_t6)

```

# Figures

Fig9 - Point - survival final census over nominal Wave Energy Level

```{r}
# Convert WaveEnergyLevel column to numeric
merged_data_finalcensus$WaveEnergyLevel <- as.numeric(merged_data_finalcensus$WaveEnergyLevel)


plot9 <- ggplot(merged_data_finalcensus, aes(x = WaveEnergyLevel, y = Perc_SurvDev, color = Reef)) +
  geom_point(size=3) +
  geom_smooth() + 
  labs(title = "Survival over nominal Wave Energy Level (final census)",
       x = "nominal Wave Energy Level",
       y = "% Survival (yield)") +
  theme_bw() +
  ylim(0,1) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Reef, scales = "free")

plot9
ggsave("Fig9 - Survival final census WaveEnergyLevel - yield.png", plot=plot9, width = 14, height = 6, dpi = 300)
```

### Fig10 - Point - survival final census over Ub

```{r}
plot10 <- ggplot(merged_data_finalcensus, aes(x = Ub_avrg, y = Perc_SurvDev, color = Reef)) +
  geom_point(size=3) +
  geom_smooth() + 
  labs(title = "Survival over Ub (final census)",
       x = "Bottomstress (Ub)",
       y = "% Survival (yield)") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,.8) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Reef, scales = "free")

plot10
ggsave("Fig10 - Survival final census Ub - yield.png", plot=plot10, width = 14, height = 6, dpi = 300)
```

### Fig11 - Point - survival final census over median current

```{r}
plot11 <- ggplot(merged_data_finalcensus, aes(x = median_speed, y = Perc_SurvDev, color = Reef)) +
  geom_point(size=3) +
  geom_smooth() + 
  labs(title = "Survival over median current (final census)",
       x = "median current (m/s)",
       y = "% Survival (yield)") +
  theme_bw() +
  ylim(0,1) +
  xlim(0,.3) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  facet_wrap(~Reef, scales = "free")

plot11
ggsave("Fig11 - Survival final census median current - yield.png", plot=plot11, width = 14, height = 6, dpi = 300)
```

```{r}
#####

Fig2 <- SummaryData |>
  ggplot(aes(y=PerSurv_t6*100, x=Current_Marotte_median))+
  geom_point()+
  geom_smooth(se=FALSE)+
  facet_grid(~Reef)+
  ylim(0,100)

Fig3 <- SummaryData %>%
  ggplot(aes(y=PerSurv_t6*100, x=NomWaveEnergy))+
  geom_point()+
  geom_smooth(se=FALSE)+
  facet_grid(~Reef)+
  ylim(0,100)+
  ylab("Percent survival")


ggsave("Fig1_ModelWaveEnergy_t6.png", Fig1, width = 6, units = "in")
ggsave("Fig2_MarotteaveEnergy_t6.png", Fig2, width = 6, units = "in")
ggsave("Fig3_NominalWaveEnergy_t6.png", Fig3, width = 6, units = "in")


Fig4 <- Data %>%
  ggplot(aes(y=PerSurv*100, x=ModelWaveEnergy))+
  geom_point()+
  geom_smooth(method = "lm", se=FALSE)+
  facet_grid(~Reef)+
  ylim(0,100)

Fig5 <- Data %>%
  ggplot(aes(y=PerSurv*100, x=NomWaveEnergy))+
  geom_point()+
  geom_smooth(method = "lm", se=FALSE)+
  facet_grid(~Reef)+
  ylim(0,100)
  
Fig6 <- Data %>%
  ggplot(aes(y=PerSurv*100, x=ModelWaveEnergyExt))+
  geom_point()+
  geom_smooth(method = "lm", se=FALSE)+
  facet_grid(~Reef)+
  ylim(0,100)+
  ylab("Percent survival")


ggsave("Fig4_ModelWaveEnergy_lm_t6.png", Fig4, width = 6, units = "in")
ggsave("Fig5_NomWaveEnergy_lm_t6.png", Fig5, width = 6, units = "in")
ggsave("Fig6_ModelWaveEnergyExt_lm_t6.png", Fig6, width = 6, units = "in")

Data %>%
  filter(Reef != "Moore") %>%
  ggplot(aes(y=PerSurv*100, x=SedPodAvg))+
  geom_point()+
  geom_smooth(se=FALSE)+
  facet_grid(~Reef)+
  ylab("Percent survival")+
  scale_x_continuous(trans = "log10")

Data %>%
  filter(Reef != "Moore") %>%
  ggplot(aes(y=PerSurv*100, x=TurfPodAvg))+
  geom_point()+
  geom_smooth(se=FALSE)+
  facet_grid(~Reef)+
  ylab("Percent survival")+
  scale_x_continuous(trans = "log10")

       
```
